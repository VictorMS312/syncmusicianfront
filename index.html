<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sync Musician v8.5 - Production</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1f1f1f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<header class="header">
    <button id="btn-home-header" class="btn-icon-header" onclick="goHome()">üè†</button>
    <h2 id="page-title">Minha Biblioteca</h2>
    <div id="status-dot" class="status-badge"></div>
    <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
</header>

<aside id="sidebar" class="sidebar">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin:0">Conex√£o</h3>
        <button onclick="toggleMenu()" style="background:none; border:none; color:#888; font-size: 24px;">‚úï</button>
    </div>
    <hr style="border:0; border-top:1px solid #333; margin: 15px 0;">
    
    <div id="menu-start">
        <button class="btn" onclick="initRole('S')">MODO L√çDER</button>
        <button class="btn btn-ghost" onclick="showMenuSection('menu-join')">MODO M√öSICO</button>
    </div>

    <div id="menu-leader" class="hidden">
        <div class="qr-panel">
            <small style="color:#059669">ID DA SESS√ÉO</small><br>
            <strong id="display-id">---</strong><br>
            <img id="qr-img" src="" alt="QR Code">
        </div>
        <button class="btn btn-danger" onclick="resetConnection()">ENCERRAR LIDERAN√áA</button>
    </div>

    <div id="menu-join" class="hidden">
        <input type="text" id="join-id" placeholder="ID do L√≠der">
        <div style="display:flex; gap:5px; margin-top:10px;">
            <button class="btn" onclick="initRole('M')" style="margin:0; flex:2">CONECTAR</button>
            <button class="btn btn-ghost" onclick="startScanner()" style="margin:0; flex:1">üì∑</button>
        </div>
        <div id="reader" class="hidden" style="margin-top:10px;"></div>
        <button class="btn btn-ghost" onclick="showMenuSection('menu-start')" style="margin-top:15px;">VOLTAR</button>
    </div>

    <div id="menu-musician-connected" class="hidden">
        <div style="text-align:center; padding:15px; background:#05966922; border-radius:10px; color: #059669; font-weight: bold;">
            ‚úì CONECTADO
        </div>
        <button class="btn btn-danger" onclick="resetConnection()">DESCONECTAR</button>
    </div>
</aside>

<div id="overlay" class="overlay" onclick="toggleMenu()"></div>

<main class="container" id="content-area">
    <div id="setlist-container">
        <div class="add-bar" id="senior-controls" style="display:none; gap:5px; margin-bottom:20px;">
            <input type="text" id="url-input" placeholder="Link Cifra Club">
            <button id="btn-save" class="btn" style="margin:0; width:auto;" onclick="addSong()">SALVAR</button>
        </div>
        <div id="setlist"></div>
    </div>
</main>

<section id="main-app" class="hidden">
    <div class="performance-tools">
        <div id="info-tom">
            TOM: <span id="curr-val" class="tom-destaque">-</span>
            <small>(Original: <span id="orig-val">-</span>)</small>
        </div>
        <div style="display:flex; gap:5px;">
            <button class="btn-action" onclick="toggleToneGrid()" style="background:#ff9800; color:#000;">TOM</button>
            <button class="btn-action" onclick="toggleScrollPanel()">SCROLL</button>
            <button class="btn-action btn-danger" onclick="deleteCurrentSong()">APAGAR</button>
        </div>
    </div>

    <div id="scroll-panel" class="hidden">
        <button id="btn-play-scroll" class="btn-action" onclick="toggleAutoScroll()" style="background:#059669;">PLAY</button>
        <input type="range" id="scroll-speed" min="1" max="100" value="20">
    </div>

    <div id="tone-grid" class="hidden"></div>

    <div id="cifra-wrapper">
        <div id="cifra-container">Selecione uma m√∫sica...</div>
    </div>
</section>

<script>
    let peer, connections = [], role = '';
    let savedSongs = JSON.parse(localStorage.getItem('setlist') || '[]');
    let currentSongIndex = -1, originalCifraText = "", currentTransposedText = ""; 
    let currentTone = "-", baseNote = "C", currentPeerId = "", html5QrCode;
    
    let isScrolling = false;
    let scrollPos = 0; 
    let wakeLock = null; 
    
    const wrapper = document.getElementById('cifra-wrapper');
    const notes = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];

    window.onload = () => {
        renderSetlist();
        const lastLeaderId = localStorage.getItem('last_leader_id');
        if (lastLeaderId) document.getElementById('join-id').value = lastLeaderId;
    };

    // --- NAVEGA√á√ÉO E MENU ---
    function toggleMenu() {
        document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('overlay').classList.toggle('active');
        if (html5QrCode) stopScanner();
    }

    function showMenuSection(sectionId) {
        ['menu-start', 'menu-leader', 'menu-join', 'menu-musician-connected'].forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });
        document.getElementById(sectionId).classList.remove('hidden');
    }

    function goHome() {
        isScrolling = false;
        document.getElementById('main-app').classList.add('hidden');
        document.getElementById('content-area').classList.remove('hidden');
        document.getElementById('page-title').innerText = "Minha Biblioteca";
    }

    function closeApp() { goHome(); }

    // --- CONEX√ÉO ---
    function initRole(r) {
        if (peer) peer.destroy();
        role = r;
        
        if (role === 'S') {
            let savedId = localStorage.getItem('my_fixed_leader_id') || 'banda-' + Math.random().toString(36).substr(2, 5);
            localStorage.setItem('my_fixed_leader_id', savedId);
            peer = new Peer(savedId);
        } else {
            peer = new Peer();
        }

        peer.on('open', id => {
            document.getElementById('status-dot').style.background = "#10b981";
            if (role === 'S') {
                currentPeerId = id;
                document.getElementById('display-id').innerText = id;
                document.getElementById('qr-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${id}`;
                showMenuSection('menu-leader');
                document.getElementById('senior-controls').style.display = 'flex';
                renderToneGrid();
            } else {
                const idToJoin = document.getElementById('join-id').value.trim();
                if(idToJoin) setupMusician(idToJoin);
            }
        });

        peer.on('connection', c => {
            connections.push(c);
            c.on('open', () => { 
                if (currentTransposedText) c.send({ type: 'SYNC', body: currentTransposedText, tone: currentTone }); 
            });
        });
    }

    function setupMusician(id) {
        localStorage.setItem('last_leader_id', id);
        const c = peer.connect(id);
        c.on('open', () => {
            document.getElementById('status-dot').style.background = "#10b981";
            showMenuSection('menu-musician-connected');
            toggleMenu();
        });
        c.on('data', data => {
            if (data.type === 'SYNC') { 
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('content-area').classList.add('hidden');
                renderCifraComCores(data.body); 
                document.getElementById('curr-val').innerText = data.tone;
            }
            if (data.type === 'SCROLL') wrapper.scrollTop = data.pos;
        });
    }

    function resetConnection() {
        if (peer) peer.destroy();
        peer = null;
        connections = [];
        document.getElementById('status-dot').style.background = "#555";
        document.getElementById('senior-controls').style.display = 'none';
        showMenuSection('menu-start');
    }

    // --- SCANNER ---
    function startScanner() {
        const readerDiv = document.getElementById('reader');
        readerDiv.classList.remove('hidden');
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (decodedText) => {
            document.getElementById('join-id').value = decodedText;
            stopScanner();
            initRole('M');
        }).catch(err => alert("C√¢mera indispon√≠vel"));
    }

    function stopScanner() {
        if (html5QrCode) {
            html5QrCode.stop().then(() => {
                document.getElementById('reader').classList.add('hidden');
                html5QrCode = null;
            });
        }
    }

    // --- CIFRAS E SETLIST ---
    function renderSetlist() {
        const container = document.getElementById('setlist');
        container.innerHTML = '';
        savedSongs.forEach((song, index) => {
            const div = document.createElement('div');
            div.className = `song-item ${index === currentSongIndex ? 'active' : ''}`;
            div.innerHTML = `<strong>${song.title}</strong><br><small>${song.originalTone}</small>`;
            div.onclick = () => selectSong(index);
            container.appendChild(div);
        });
    }

    function selectSong(index) {
        currentSongIndex = index;
        const song = savedSongs[index];
        originalCifraText = song.content;
        currentTransposedText = song.content;
        currentTone = song.originalTone;
        baseNote = song.originalTone;
        
        document.getElementById('main-app').classList.remove('hidden');
        document.getElementById('content-area').classList.add('hidden');
        document.getElementById('page-title').innerText = song.title;
        document.getElementById('orig-val').innerText = song.originalTone;
        document.getElementById('curr-val').innerText = song.originalTone;
        
        wrapper.scrollTop = 0; scrollPos = 0;
        renderSetlist();
        updateAndSync(currentTransposedText, currentTone);
    }

    function updateAndSync(text, tone) {
        renderCifraComCores(text);
        if(role === 'S') connections.forEach(c => { if (c.open) c.send({ type: 'SYNC', body: text, tone: tone }); });
    }

    function renderCifraComCores(text) {
        const html = text.replace(/[A-G][#b]?[mmax0-9s]*(?=\s|$|\/|\()/g, '<span class="chord">$&</span>');
        document.getElementById('cifra-container').innerHTML = html;
    }

    async function addSong() {
        const url = document.getElementById('url-input').value.trim();
        if (!url) return;
        try {
            const res = await fetch(`https://syncmusician.onrender.com/get-cifra?url=${encodeURIComponent(url)}`);
            const data = await res.json();
            savedSongs.push({ title: data.titulo || "Sem t√≠tulo", content: data.cifra, url: url, originalTone: data.tom || "C" });
            localStorage.setItem('setlist', JSON.stringify(savedSongs));
            renderSetlist();
            document.getElementById('url-input').value = '';
        } catch (e) { alert("Erro ao carregar cifra."); }
    }

    // --- TRANSPOSTOR E TOOLS ---
    function renderToneGrid() {
        const grid = document.getElementById('tone-grid');
        grid.innerHTML = '';
        notes.forEach(note => {
            const btn = document.createElement('button');
            btn.className = 'btn-tone-pick'; btn.innerText = note;
            btn.onclick = () => { selectDirectTone(note); toggleToneGrid(); };
            grid.appendChild(btn);
        });
    }

    function selectDirectTone(targetNote) {
        if (currentSongIndex === -1) return;
        const diff = notes.indexOf(targetNote) - notes.indexOf(baseNote);
        currentTransposedText = transposeText(originalCifraText, diff);
        currentTone = targetNote;
        document.getElementById('curr-val').innerText = targetNote;
        updateAndSync(currentTransposedText, currentTone);
    }

    function transposeText(text, diff) {
        return text.replace(/[A-G][#b]?/g, (match) => {
            let note = match.endsWith('b') ? ({"Db":"C#", "Eb":"D#", "Gb":"F#", "Ab":"G#", "Bb":"A#"}[match] || match) : match;
            let index = notes.indexOf(note);
            if (index === -1) return match;
            let newIndex = (index + diff) % 12;
            while (newIndex < 0) newIndex += 12;
            return notes[newIndex];
        });
    }

    function toggleToneGrid() { document.getElementById('tone-grid').classList.toggle('hidden'); }
    function toggleScrollPanel() { document.getElementById('scroll-panel').classList.toggle('hidden'); }
    
    function deleteCurrentSong() {
        if (!confirm("Apagar m√∫sica?")) return;
        savedSongs.splice(currentSongIndex, 1);
        localStorage.setItem('setlist', JSON.stringify(savedSongs));
        currentSongIndex = -1;
        renderSetlist();
        goHome();
    }

    function toggleAutoScroll() {
        isScrolling = !isScrolling;
        const btn = document.getElementById('btn-play-scroll');
        if (isScrolling) {
            scrollPos = wrapper.scrollTop;
            btn.innerText = "STOP"; btn.style.background = "#b91c1c";
            scrollLoop();
        } else {
            btn.innerText = "PLAY"; btn.style.background = "#059669";
        }
    }

    function scrollLoop() {
        if (!isScrolling) return;
        const speed = (parseFloat(document.getElementById('scroll-speed').value) / 50); 
        scrollPos += speed;
        wrapper.scrollTop = Math.floor(scrollPos);
        if (role === 'S') connections.forEach(c => { if (c.open) c.send({ type: 'SCROLL', pos: wrapper.scrollTop }); });
        requestAnimationFrame(scrollLoop);
    }
</script>
</body>
</html>