<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sync Musician v6.0</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1f1f1f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<body>

<header class="header">
    <h2 id="page-title">Minha Biblioteca</h2>
    <div id="status-dot" class="status-badge"></div>
    <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
</header>

<aside id="sidebar" class="sidebar">
    <h3>Conex√£o</h3>
    <hr>
    
    <div id="menu-start">
        <button class="btn" onclick="initRole('S')">MODO L√çDER</button>
        <button class="btn btn-ghost" onclick="showMenuSection('menu-join')">MODO M√öSICO</button>
    </div>

    <div id="menu-leader" class="hidden">
        <div class="qr-panel">
            <small>ID DA SESS√ÉO</small><br>
            <strong id="display-id">---</strong><br>
            <img id="qr-img" src="" alt="QR Code">
        </div>
        <button class="btn btn-danger" onclick="resetConnection()">ENCERRAR LIDERAN√áA</button>
    </div>

    <div id="menu-join" class="hidden">
        <input type="text" id="join-id" placeholder="ID do L√≠der">
        <div style="display:flex; gap:5px;">
            <button class="btn" onclick="initRole('M')" style="flex:2">CONECTAR</button>
            <button class="btn btn-ghost" onclick="startScanner()" style="flex:1">üì∑</button>
        </div>
        <div id="reader" class="hidden"></div>
        <button class="btn btn-ghost" onclick="showMenuSection('menu-start')">VOLTAR</button>
    </div>

    <div id="menu-musician-connected" class="hidden">
        <div style="text-align:center; padding:20px; background:#05966922; border-radius:10px; color: #059669; font-weight: bold;">
            ‚úì CONECTADO
        </div>
        <button class="btn btn-danger" onclick="resetConnection()">DESCONECTAR</button>
    </div>
</aside>

<div id="overlay" class="overlay" onclick="toggleMenu()"></div>

<main class="container" id="content-area">
    </main>

<section id="main-app" class="hidden">
    <div class="header-performance">
        <button class="btn-ghost" onclick="closeApp()">‚¨Ö VOLTAR</button>
        <span id="status-perf">MODO L√çDER</span>
    </div>
    
    <div id="cifra-content">
        </div>
</section>
<script>
    let peer, connections = [], role = '';
    let savedSongs = JSON.parse(localStorage.getItem('setlist') || '[]');
    let currentSongIndex = -1, originalCifraText = "", currentTransposedText = ""; 
    let currentTone = "-", baseNote = "C", currentPeerId = "", html5QrCode;
    
    let isScrolling = false;
    let scrollPos = 0; 
    let wakeLock = null; 
    const wrapper = document.getElementById('cifra-wrapper');
    const notes = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];

    // 1. PERSIST√äNCIA AO CARREGAR
    window.onload = () => {
        renderSetlist();
        const lastLeaderId = localStorage.getItem('last_leader_id');
        if (lastLeaderId) {
            document.getElementById('join-id').value = lastLeaderId;
            document.getElementById('last-session-info').innerText = "√öltimo ID conectado: " + lastLeaderId;
        }
        
        const lastSong = localStorage.getItem('last_viewed_song');
        if (lastSong) {
            renderCifraComCores(lastSong);
            document.getElementById('status').innerText = "MODO OFFLINE (Cache)";
        }
    };

    // 2. FUN√á√ÉO HOME
    function goHome() {
        isScrolling = false;
        if (peer) peer.destroy(); 
        document.getElementById('main-app').classList.add('hidden');
        document.getElementById('setup-screen').classList.remove('hidden');
        document.getElementById('btn-home').style.display = 'none';
        document.getElementById('status').innerText = "Conectando...";
    }

    async function requestWakeLock() {
        if ('wakeLock' in navigator) {
            try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
        }
    }

    function initRole(r) {
        role = r;
        
        // --- NOVIDADE: ID FIXO PARA O L√çDER ---
        if (role === 'S') {
            // Tenta recuperar um ID salvo, se n√£o existir, cria um aleat√≥rio curto
            let savedId = localStorage.getItem('my_fixed_leader_id');
            if (!savedId) {
                savedId = 'banda-' + Math.random().toString(36).substr(2, 5);
                localStorage.setItem('my_fixed_leader_id', savedId);
            }
            peer = new Peer(savedId); // O L√≠der agora pede sempre o mesmo ID
        } else {
            peer = new Peer(); // O m√∫sico continua com ID aleat√≥rio
        }

        document.getElementById('setup-screen').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        document.getElementById('btn-home').style.display = 'block';

        requestWakeLock();

        if (role === 'S') {
            setupLeader();
        } else {
            const id = document.getElementById('join-id').value.trim();
            if (!id) { alert("Insira o ID do L√≠der"); return goHome(); }
            localStorage.setItem('last_leader_id', id);
            setupMusician(id);
        }
    }

    function setupLeader() {
        document.getElementById('senior-controls').classList.remove('hidden');
        document.getElementById('senior-header-controls').classList.remove('hidden');
        document.getElementById('btn-toggle-tone').style.display = 'block';
        peer.on('open', id => {
            currentPeerId = id;
            document.getElementById('status').innerText = "MODO: L√çDER";
            document.getElementById('qr-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${id}`;
        });
        peer.on('connection', c => {
            connections.push(c);
            c.on('open', () => { 
                if (currentTransposedText) c.send({ type: 'SYNC', body: currentTransposedText, tone: currentTone }); 
            });
        });
        wrapper.onscroll = () => { if (role === 'S' && !isScrolling) syncScrollPosition(); };
        renderToneGrid();
    }

    function setupMusician(id) {
        peer.on('open', () => {
            document.getElementById('status').innerText = "CONECTANDO AO L√çDER...";
            const c = peer.connect(id);
            handleMusicianConnection(c, id);
        });
    }

    function handleMusicianConnection(c, id) {
        c.on('open', () => {
            document.getElementById('status').innerText = "MODO: M√öSICO (Conectado)";
        });
        c.on('data', data => {
            if (data.type === 'SYNC') { 
                renderCifraComCores(data.body); 
                document.getElementById('curr-val').innerText = data.tone;
                localStorage.setItem('last_viewed_song', data.body);
            }
            if (data.type === 'SCROLL') wrapper.scrollTop = data.pos;
        });
        c.on('close', () => {
            document.getElementById('status').innerText = "CONEX√ÉO PERDIDA. RECONECTANDO...";
            setTimeout(() => { if(role === 'M') setupMusician(id); }, 3000);
        });
    }

    // --- ROLAGEM, CIFRAS E OUTRAS FUN√á√ïES (MANTIDAS) ---
    function scrollLoop() {
        if (!isScrolling) return;
        const speed = (parseFloat(document.getElementById('scroll-speed').value) / 50); 
        scrollPos += speed;
        wrapper.scrollTop = Math.floor(scrollPos);
        if (role === 'S') syncScrollPosition();
        requestAnimationFrame(scrollLoop);
    }

    function toggleAutoScroll() {
        const btn = document.getElementById('btn-play-scroll');
        isScrolling = !isScrolling;
        if (isScrolling) {
            scrollPos = wrapper.scrollTop; 
            btn.innerText = "STOP"; btn.style.background = "#b91c1c";
            scrollLoop();
        } else {
            btn.innerText = "PLAY"; btn.style.background = "#059669";
        }
    }

    function syncScrollPosition() {
        connections.forEach(c => { if (c.open) c.send({ type: 'SCROLL', pos: wrapper.scrollTop }); });
    }

    function renderCifraComCores(text) {
        const html = text.replace(/[A-G][#b]?[mmax0-9s]*(?=\s|$|\/|\()/g, '<span class="chord">$&</span>');
        document.getElementById('cifra-container').innerHTML = html;
    }

    async function addSong() {
        const btn = document.getElementById('btn-save');
        const urlInput = document.getElementById('url-input');
        const url = urlInput.value.trim();
        if (!url) return;
        btn.innerText = "CARREGANDO..."; btn.disabled = true;
        try {
            const res = await fetch(`https://syncmusician.onrender.com/get-cifra?url=${encodeURIComponent(url)}`);
            const data = await res.json();
            savedSongs.push({ title: data.titulo || "Sem t√≠tulo", content: data.cifra, url: url, originalTone: "C" });
            localStorage.setItem('setlist', JSON.stringify(savedSongs));
            renderSetlist();
            urlInput.value = '';
        } catch (e) { alert("Erro ao carregar."); }
        finally { btn.innerText = "+ SALVAR"; btn.disabled = false; }
    }

    function renderSetlist() {
        const container = document.getElementById('setlist');
        container.innerHTML = '';
        savedSongs.forEach((song, index) => {
            const div = document.createElement('div');
            div.className = `song-item ${index === currentSongIndex ? 'active' : ''}`;
            div.innerText = song.title;
            div.onclick = () => selectSong(index);
            container.appendChild(div);
        });
    }

    function selectSong(index) {
        currentSongIndex = index;
        const song = savedSongs[index];
        originalCifraText = song.content;
        currentTransposedText = song.content;
        currentTone = song.originalTone;
        baseNote = song.originalTone;
        document.getElementById('orig-val').innerText = song.originalTone;
        document.getElementById('curr-val').innerText = song.originalTone;
        wrapper.scrollTop = 0; scrollPos = 0;
        renderSetlist();
        updateAndSync(currentTransposedText, currentTone);
    }

    function updateAndSync(text, tone) {
        renderCifraComCores(text);
        connections.forEach(c => { if (c.open) c.send({ type: 'SYNC', body: text, tone: tone }); });
    }

    function renderToneGrid() {
        const grid = document.getElementById('tone-grid');
        grid.innerHTML = '';
        notes.forEach(note => {
            const btn = document.createElement('button');
            btn.className = 'btn-tone-pick'; btn.innerText = note;
            btn.onclick = () => { selectDirectTone(note); toggleToneGrid(); };
            grid.appendChild(btn);
        });
    }

    function selectDirectTone(targetNote) {
        if (currentSongIndex === -1) return;
        const diff = notes.indexOf(targetNote) - notes.indexOf(baseNote);
        currentTransposedText = transposeText(originalCifraText, diff);
        currentTone = targetNote;
        document.getElementById('curr-val').innerText = targetNote;
        updateAndSync(currentTransposedText, currentTone);
    }

    function transposeText(text, diff) {
        return text.replace(/[A-G][#b]?/g, (match) => {
            let note = match.endsWith('b') ? ({"Db":"C#", "Eb":"D#", "Gb":"F#", "Ab":"G#", "Bb":"A#"}[match] || match) : match;
            let index = notes.indexOf(note);
            if (index === -1) return match;
            let newIndex = (index + diff) % 12;
            while (newIndex < 0) newIndex += 12;
            return notes[newIndex];
        });
    }

    function toggleToneGrid() {
        const grid = document.getElementById('tone-grid');
        grid.style.display = (grid.style.display === 'grid') ? 'none' : 'grid';
    }

    function toggleScrollPanel() {
        const panel = document.getElementById('scroll-panel');
        panel.style.display = (panel.style.display === 'flex') ? 'none' : 'flex';
    }

    function copyID() { if (currentPeerId) navigator.clipboard.writeText(currentPeerId).then(() => alert("ID Copiado!")); }
    function toggleQR() { const q = document.getElementById('qr-modal'); q.style.display = q.style.display === 'block' ? 'none' : 'block'; }
    function deleteCurrentSong() {
        if (currentSongIndex === -1) return;
        savedSongs.splice(currentSongIndex, 1);
        localStorage.setItem('setlist', JSON.stringify(savedSongs));
        currentSongIndex = -1; renderSetlist();
        document.getElementById('cifra-container').innerHTML = "M√∫sica removida.";
    }

    function startScanner() {
        const readerDiv = document.getElementById('reader');
        readerDiv.style.display = 'block';
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (decodedText) => {
            document.getElementById('join-id').value = decodedText;
            stopScanner();
        }).catch(err => alert("C√¢mera n√£o dispon√≠vel"));
    }

    function stopScanner() { if (html5QrCode) { html5QrCode.stop().then(() => { document.getElementById('reader').style.display = 'none'; }); } }
</script>
</body>
</html>